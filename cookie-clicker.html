<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0" />
    <title>Cookie Clicker</title>
    <link rel="stylesheet" href="Styles/style.css">
    <style>
        /* Base page styling */
        body {
            text-align: center;
            margin: 0;
            padding: 0 16px 60px;
            color: #000;
        }

        /* Simple nav */
        nav ul {
            list-style: none;
            display: flex;
            gap: 16px;
            padding: 12px 16px;
            margin: 16px auto 0;
            background: #222;
            border-radius: 8px;
            flex-wrap: wrap;
        }

        nav a {
            color: #f2f2f2;
            text-decoration: none;
            font-weight: bold;
            padding: 8px 12px;
            border-radius: 6px;
        }

        nav a:hover {
            background: #333;
        }

        main {
            margin-top: 24px;
        }

        h2 {
            font-size: 32px;
            color: inherit;
            margin: 12px 0 8px;
        }

        #score {
            font-size: 28px;
            font-weight: bold;
            margin: 8px 0 12px;
            color: inherit;
        }

        #stats {
            color: inherit;
            font-weight: bold;
            margin-bottom: 18px;
        }

        /* Cookie styling */
        #cookie {
            width: 200px;
            height: 200px;
            background-color: #d2691e;
            border-radius: 50%;
            display: inline-block;
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.1s;
            position: relative;
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.2);
            user-select: none;
            overflow: visible;
        }

        .cookie-zone {
            position: relative;
            display: inline-block;
        }

        #cookie:active {
            transform: scale(0.92);
            box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.2);
        }

        .chocolate-chip {
            width: 18px;
            height: 18px;
            background-color: #4b2e1f;
            border-radius: 50%;
            position: absolute;
            z-index: 1;
        }

        #cursor-orbits {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            pointer-events: none;
            z-index: 2;
        }

        .cursor-orbit {
            position: absolute;
            top: 0;
            left: 0;
            width: 0;
            height: 0;
            transform: rotate(var(--start-angle));
        }

        .cursor-spin {
            position: absolute;
            top: 0;
            left: 0;
            width: 0;
            height: 0;
            animation: orbit-spin 6s linear infinite;
        }

        .cursor-triangle {
            width: 0;
            height: 0;
            border-left: 7px solid transparent;
            border-right: 7px solid transparent;
            border-bottom: 12px solid var(--accent);
            filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.2));
        }

        #effects-layer {
            position: absolute;
            inset: -10px;
            pointer-events: none;
            z-index: 3;
        }

        .float-text {
            position: absolute;
            font-weight: bold;
            color: #0b5138;
            text-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
            animation: float-up 900ms ease-out forwards;
            font-size: 14px;
            white-space: nowrap;
        }

        .float-text.bonus {
            color: #b85c00;
        }

        @keyframes float-up {
            0% { transform: translate(-50%, -10%); opacity: 0; }
            20% { opacity: 1; }
            100% { transform: translate(-50%, -120%); opacity: 0; }
        }

        #golden-cookie {
            position: absolute;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #fff4b0, #f2c14b 60%, #c28b18);
            box-shadow: 0 6px 12px rgba(194, 139, 24, 0.4);
            border: 2px solid rgba(255, 255, 255, 0.7);
            display: none;
            cursor: pointer;
            z-index: 4;
            animation: golden-pulse 1.4s ease-in-out infinite;
        }

        @keyframes golden-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.08); }
        }

        @keyframes orbit-spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Chip positions */
        .chip1 { top: 30px; left: 60px; }
        .chip2 { top: 70px; right: 50px; }
        .chip3 { bottom: 40px; left: 80px; }
        .chip4 { top: 100px; left: 110px; }
        .chip5 { bottom: 30px; right: 60px; }
        .chip6 { top: 40px; right: 80px; }
        .chip7 { bottom: 80px; left: 40px; }

        /* Buttons */
        button {
            padding: 12px 24px;
            font-size: 16px;
            cursor: pointer;
            background-color: var(--accent);
            color: white;
            border: none;
            border-radius: 8px;
            margin-top: 16px;
            transition: background-color 0.3s, opacity 0.2s;
        }

        button:hover {
            background-color: #038c59;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Shop / upgrades */
        .layout {
            display: grid;
            grid-template-columns: 1fr;
            gap: 24px;
            max-width: 920px;
            margin: 0 auto;
        }

        .column {
            display: grid;
            gap: 24px;
        }

        @media (min-width: 880px) {
            .layout {
                grid-template-columns: 360px 1fr;
                align-items: start;
            }
        }

        .panel {
            background: var(--card);
            color: #111111;
            border: 1px solid #dfe6f2;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 6px 18px rgba(15, 30, 50, 0.06);
        }

        .panel h3 {
            margin: 0 0 12px;
            color: inherit;
        }

        #shop .upgrade {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 8px 12px;
            align-items: center;
            border: 1px solid #dfe6f2;
            border-radius: 10px;
            padding: 10px 12px;
            margin-bottom: 10px;
            background: #f7f9fc;
        }

        #shop {
            max-height: 420px;
            overflow-y: auto;
            padding-right: 6px;
        }

        #shop::-webkit-scrollbar {
            width: 8px;
        }

        #shop::-webkit-scrollbar-track {
            background: #e7ecf5;
            border-radius: 999px;
        }

        #shop::-webkit-scrollbar-thumb {
            background: #c3cfdf;
            border-radius: 999px;
        }

        #achievements {
            max-height: 320px;
            overflow-y: auto;
            padding-right: 6px;
        }

        #achievements::-webkit-scrollbar {
            width: 8px;
        }

        #achievements::-webkit-scrollbar-track {
            background: #e7ecf5;
            border-radius: 999px;
        }

        #achievements::-webkit-scrollbar-thumb {
            background: #c3cfdf;
            border-radius: 999px;
        }

        .purchase-pulse {
            animation: purchase-flash 600ms ease-out;
        }

        @keyframes purchase-flash {
            0% { box-shadow: 0 0 0 rgba(4, 170, 109, 0); transform: translateY(0); }
            40% { box-shadow: 0 0 14px rgba(4, 170, 109, 0.35); transform: translateY(-2px); }
            100% { box-shadow: 0 0 0 rgba(4, 170, 109, 0); transform: translateY(0); }
        }

        .upgrade-title {
            font-weight: bold;
            color: #111111;
        }

        .upgrade-desc {
            color: var(--muted);
            font-size: 13px;
        }

        .upgrade-meta {
            color: #111111;
            font-size: 13px;
        }

        .upgrade-actions {
            display: flex;
            flex-direction: column;
            gap: 6px;
            align-items: flex-end;
        }

        .inline {
            display: inline-block;
            min-width: 64px;
            text-align: right;
        }

        .muted {
            color: var(--muted);
            font-size: 13px;
        }

        .achievement {
            border: 1px solid #dfe6f2;
            border-radius: 8px;
            padding: 8px 10px;
            background: #f7f9fc;
            margin-bottom: 8px;
            text-align: left;
        }

        .achievement.locked {
            opacity: 0.55;
        }

        .achievement-title {
            font-weight: bold;
        }

        .milestone {
            font-size: 13px;
            color: #111111;
            text-align: left;
            margin-bottom: 6px;
        }

        .milestone-bar {
            height: 6px;
            background: #e7ecf5;
            border-radius: 999px;
            overflow: hidden;
            margin-top: 4px;
        }

        .milestone-fill {
            height: 100%;
            background: var(--accent);
            width: 0%;
        }

        .music-frame {
            width: 100%;
            aspect-ratio: 16 / 9;
            border: 0;
            border-radius: 10px;
        }

        .secret-rickroll {
            position: fixed;
            bottom: 8px;
            right: 8px;
            width: 22px;
            height: 22px;
            opacity: 0;
            background: transparent;
            border: 0;
            cursor: pointer;
            z-index: 10;
        }
    </style>
</head>

<body>
    <nav>
        <ul>
            <li><a href="index.html">Home</a></li>
            <li><a href="cookie-clicker.html">Cookie Clicker</a></li>
            <li><a href="who-am-i.html">Who Am I</a></li>
            <li><a href="Hobbies.html">Hobbies</a></li>
            <li><a href="chat-bot.html">Chat Bot</a></li>
        </ul>
    </nav>
    <div class="theme-controls">
        <button class="theme-toggle" type="button" id="themeToggle">Dark Mode</button>
    </div>

    <main>
        <h1>Cookie Clicker</h1>
        <p>Score: <span id="score">0</span></p>
        <div id="stats">
            CPC: <span id="cpc">1</span> | CPS: <span id="cps">0</span>
        </div>

        <div class="layout">
            <div class="column">
                <div class="panel">
                    <div class="cookie-zone">
                        <div id="cookie" title="Click me!">
                            <div id="cursor-orbits" aria-hidden="true"></div>
                            <div class="chocolate-chip chip1"></div>
                            <div class="chocolate-chip chip2"></div>
                            <div class="chocolate-chip chip3"></div>
                            <div class="chocolate-chip chip4"></div>
                            <div class="chocolate-chip chip5"></div>
                            <div class="chocolate-chip chip6"></div>
                            <div class="chocolate-chip chip7"></div>
                        </div>
                        <div id="golden-cookie" aria-label="Golden cookie"></div>
                        <div id="effects-layer" aria-hidden="true"></div>
                    </div>
                    <br />
                    <button id="reset-button">Reset Progress</button>
                </div>

                <div class="panel">
                    <h3>Achievements</h3>
                    <div id="achievements"></div>
                    <h3>Milestones</h3>
                    <div id="milestones"></div>
                </div>
            </div>

            <div class="column">
                <div class="panel">
                    <h3>Upgrades</h3>
                    <div id="shop"></div>
                    <div class="muted">Costs rise with each purchase. Progress saves automatically.</div>
                </div>

                <div class="panel">
                    <h3>Lo-fi station</h3>
                    <div class="muted">Tap play for some chill study beats.</div>
                    <iframe
                        class="music-frame"
                        src="https://www.youtube.com/live/sF80I-TQiW0?si=-ERlp-uYQpC-WuPX"
                        title="Lo-fi hip hop"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                        allowfullscreen>
                    </iframe>
                </div>
            </div>
        </div>
    </main>
    <button class="secret-rickroll" id="secret-rickroll" type="button" aria-label="Secret"></button>

    <script>
        (() => {
            const root = document.documentElement;
            const stored = localStorage.getItem("theme");
            if (stored === "light" || stored === "dark") {
                root.setAttribute("data-theme", stored);
            }
            const button = document.getElementById("themeToggle");
            if (button) {
                const setLabel = () => {
                    const isDark = root.getAttribute("data-theme") === "dark";
                    button.textContent = isDark ? "Light Mode" : "Dark Mode";
                };
                setLabel();
                button.addEventListener("click", () => {
                    const next = root.getAttribute("data-theme") === "dark" ? "light" : "dark";
                    root.setAttribute("data-theme", next);
                    localStorage.setItem("theme", next);
                    setLabel();
                });
            }
        })();
    </script>

    <script src="cookie-achievements.js"></script>
    <script>

        const SAVE_KEY = 'cookieGame.save';

        const DEFAULT_UPGRADES = [
            { id: 'cursor', name: 'Cursor', baseCost: 15, costMultiplier: 1.15, cps: 0.1, cpc: 0, count: 0, description: 'A helpful cursor that adds 0.1 CPS.' },
            { id: 'grandma', name: 'Grandma', baseCost: 100, costMultiplier: 1.15, cps: 1, cpc: 0, count: 0, description: 'A loving grandma that bakes 1 CPS.' },
            { id: 'farm', name: 'Farm', baseCost: 1100, costMultiplier: 1.15, cps: 8, cpc: 0, count: 0, description: 'Fresh cookie crops: 8 CPS.' },
            { id: 'mine', name: 'Mine', baseCost: 12000, costMultiplier: 1.15, cps: 47, cpc: 0, count: 0, description: 'Deep cookie veins: 47 CPS.' },
            { id: 'factory', name: 'Factory', baseCost: 130000, costMultiplier: 1.15, cps: 260, cpc: 0, count: 0, description: 'Mass production for 260 CPS.' },
            { id: 'bank', name: 'Bank', baseCost: 1400000, costMultiplier: 1.15, cps: 1400, cpc: 0, count: 0, description: 'Cookie investments: 1400 CPS.' },
            { id: 'temple', name: 'Temple', baseCost: 20000000, costMultiplier: 1.15, cps: 7800, cpc: 0, count: 0, description: 'Sacred baking rituals: 7,800 CPS.' },
            { id: 'shipment', name: 'Shipment', baseCost: 330000000, costMultiplier: 1.15, cps: 44000, cpc: 0, count: 0, description: 'Interstellar cookie delivery: 44,000 CPS.' },
            { id: 'alchemy', name: 'Alchemy Lab', baseCost: 5100000000, costMultiplier: 1.15, cps: 260000, cpc: 0, count: 0, description: 'Transmute ingredients into cookies: 260,000 CPS.' },
            { id: 'portal', name: 'Portal', baseCost: 75000000000, costMultiplier: 1.15, cps: 1600000, cpc: 0, count: 0, description: 'Summon cookies from beyond: 1.6M CPS.' },
            { id: 'click', name: 'Click Power', baseCost: 50, costMultiplier: 1.25, cps: 0, cpc: 1, count: 0, description: 'Each level adds +1 cookies per click.' },
            { id: 'auto-clicker', name: 'Auto Clicker', baseCost: 500, costMultiplier: 1.2, cps: 3, cpc: 0, count: 0, description: 'Automated clicks: +3 CPS.' },
            { id: 'turbo-clicker', name: 'Turbo Clicker', baseCost: 6000, costMultiplier: 1.2, cps: 0, cpc: 3, count: 0, description: 'Boost your clicks by +3 CPC.' }
        ];

        const ACHIEVEMENTS = Array.isArray(window.COOKIE_ACHIEVEMENTS) ? window.COOKIE_ACHIEVEMENTS : [];

        const MILESTONES = [
            { id: 'total-cookies', label: 'Total cookies baked', thresholds: [100, 1000, 10000, 100000, 1000000, 10000000] },
            { id: 'total-clicks', label: 'Total clicks', thresholds: [10, 50, 200, 500, 1000, 2500] },
            { id: 'cps', label: 'Cookies per second', thresholds: [1, 10, 25, 50, 100, 250, 500] }
        ];

        function newState() {
            return {
                cookies: 0,
                cpc: 1,
                upgrades: DEFAULT_UPGRADES.map(u => ({ ...u, count: 0 })),
                lastSave: Date.now(),
                totalClicks: 0,
                totalCookies: 0,
                achievements: new Set(),
                goldenClicks: 0
            };
        }

        // ====== DOM ======
        const cookieEl = document.getElementById('cookie');
        const scoreEl = document.getElementById('score');
        const cpcEl = document.getElementById('cpc');
        const cpsEl = document.getElementById('cps');
        const resetButton = document.getElementById('reset-button');
        const shopEl = document.getElementById('shop');
        const cursorOrbitsEl = document.getElementById('cursor-orbits');
        const effectsLayerEl = document.getElementById('effects-layer');
        const goldenCookieEl = document.getElementById('golden-cookie');
        const achievementsEl = document.getElementById('achievements');
        const milestonesEl = document.getElementById('milestones');
        const secretRickroll = document.getElementById('secret-rickroll');

        // ====== Helpers ======
        const UNITS = ['', 'K', 'M', 'B', 'T', 'Qa', 'Qi', 'Sx', 'Sp', 'Oc', 'No', 'Dc'];
        function formatNumber(value) {
            const abs = Math.abs(value);
            if (abs < 1000) {
                // Show up to 2 decimals for small numbers
                return (Math.round(value * 100) / 100).toString();
            }
            let unit = 0;
            let num = value;
            while (Math.abs(num) >= 1000 && unit < UNITS.length - 1) {
                num /= 1000;
                unit++;
            }
            const precision = Math.abs(num) < 10 ? 2 : (Math.abs(num) < 100 ? 1 : 0);
            return num.toFixed(precision) + UNITS[unit];
        }

        function costFor(upgrade) {
            // Typical incremental game scaling
            return Math.ceil(upgrade.baseCost * Math.pow(upgrade.costMultiplier, upgrade.count));
        }

        function totalCPS(state) {
            return state.upgrades.reduce((sum, u) => sum + (u.cps * u.count), 0);
        }

        function recomputeCPC(state) {
            // Base CPC is 1, plus any click-power upgrades
            const extra = state.upgrades.reduce((sum, u) => sum + (u.cpc * u.count), 0);
            state.cpc = 1 + extra;
        }

        // ====== Save / Load ======
        function serialize(state) {
            const counts = {};
            state.upgrades.forEach(u => counts[u.id] = u.count);
            return {
                cookies: state.cookies,
                upgrades: counts,
                lastSave: state.lastSave,
                totalClicks: state.totalClicks,
                totalCookies: state.totalCookies,
                achievements: Array.from(state.achievements),
                goldenClicks: state.goldenClicks
            };
        }

        function save(state) {
            state.lastSave = Date.now();
            try {
                localStorage.setItem(SAVE_KEY, JSON.stringify(serialize(state)));
            } catch (e) {
                console.warn('Save failed:', e);
            }
        }

        function load() {
            const raw = localStorage.getItem(SAVE_KEY);
            if (!raw) return newState();
            try {
                const data = JSON.parse(raw);
                const state = newState();
                state.cookies = typeof data.cookies === 'number' ? data.cookies : 0;
                state.totalClicks = typeof data.totalClicks === 'number' ? data.totalClicks : 0;
                state.totalCookies = typeof data.totalCookies === 'number' ? data.totalCookies : 0;
                state.achievements = new Set(Array.isArray(data.achievements) ? data.achievements : []);
                state.goldenClicks = typeof data.goldenClicks === 'number' ? data.goldenClicks : 0;

                // Rebuild upgrades from defaults to keep definitions in sync
                const savedCounts = data.upgrades || {};
                state.upgrades = DEFAULT_UPGRADES.map(def => ({
                    ...def,
                    count: typeof savedCounts[def.id] === 'number' ? savedCounts[def.id] : 0
                }));

                // Recompute CPC from upgrades
                recomputeCPC(state);

                // Offline progress
                const then = typeof data.lastSave === 'number' ? data.lastSave : Date.now();
                const seconds = Math.max(0, (Date.now() - then) / 1000);
                const cps = totalCPS(state);
                const offlineEarned = cps * seconds;

                if (offlineEarned > 0) {
                    state.cookies += offlineEarned;
                    state.totalCookies += offlineEarned;
                }
                state.lastSave = Date.now();
                return state;
            } catch (e) {
                console.warn('Load failed, starting fresh:', e);
                return newState();
            }
        }

        // ====== UI ======
        function buildShop(state) {
            shopEl.innerHTML = '';
            state.upgrades.forEach(upg => {
                const container = document.createElement('div');
                container.className = 'upgrade';
                container.id = `upgrade-${upg.id}`;

                const left = document.createElement('div');
                const title = document.createElement('div');
                title.className = 'upgrade-title';
                title.textContent = upg.name;

                const desc = document.createElement('div');
                desc.className = 'upgrade-desc';
                desc.textContent = upg.description;

                const meta = document.createElement('div');
                meta.className = 'upgrade-meta';
                meta.innerHTML = `
                    <span>Owned: <span id="count-${upg.id}">${upg.count}</span></span>
                    &nbsp;&middot;&nbsp;
                    <span>${upg.cps > 0 ? `${upg.cps} CPS each` : `+${upg.cpc} CPC each`}</span>
                `;

                left.appendChild(title);
                left.appendChild(desc);
                left.appendChild(meta);

                const right = document.createElement('div');
                right.className = 'upgrade-actions';

                const costLabel = document.createElement('div');
                costLabel.className = 'muted';
                costLabel.innerHTML = `Cost: <span id="cost-${upg.id}">${formatNumber(costFor(upg))}</span>`;

                const buyBtn = document.createElement('button');
                buyBtn.id = `buy-${upg.id}`;
                buyBtn.textContent = 'Buy';
                buyBtn.addEventListener('click', () => buyUpgrade(upg.id));

                right.appendChild(costLabel);
                right.appendChild(buyBtn);

                container.appendChild(left);
                container.appendChild(right);
                shopEl.appendChild(container);
            });
        }

        function updateUI(state) {
            if (shopEl && shopEl.children.length === 0) {
                buildShop(state);
            }
            scoreEl.textContent = formatNumber(state.cookies);
            cpcEl.textContent = formatNumber(state.cpc);
            cpsEl.textContent = formatNumber(totalCPS(state));

            state.upgrades.forEach(upg => {
                const cost = costFor(upg);
                const costSpan = document.getElementById(`cost-${upg.id}`);
                const countSpan = document.getElementById(`count-${upg.id}`);
                const buyBtn = document.getElementById(`buy-${upg.id}`);

                if (costSpan) costSpan.textContent = formatNumber(cost);
                if (countSpan) countSpan.textContent = upg.count.toString();
                if (buyBtn) buyBtn.disabled = state.cookies < cost;
            });

            updateCursorOrbits(state);
            updateAchievements(state);
            updateMilestones(state);
        }

        let lastCursorCount = -1;
        function updateCursorOrbits(state) {
            if (!cursorOrbitsEl) return;
            const cursorUpg = state.upgrades.find(u => u.id === 'cursor');
            const count = cursorUpg ? cursorUpg.count : 0;
            if (count === lastCursorCount) return;
            lastCursorCount = count;

            cursorOrbitsEl.innerHTML = '';
            if (count <= 0) return;

            const radius = Math.round(cookieEl.offsetWidth / 2 + 14);
            const fragment = document.createDocumentFragment();
            const slice = 360 / count;

            for (let i = 0; i < count; i++) {
                const orbit = document.createElement('div');
                orbit.className = 'cursor-orbit';
                orbit.style.setProperty('--start-angle', `${slice * i}deg`);

                const spinner = document.createElement('div');
                spinner.className = 'cursor-spin';
                spinner.style.animationDelay = `${(i * 0.12) % 1.5}s`;

                const triangle = document.createElement('div');
                triangle.className = 'cursor-triangle';
                triangle.style.transform = `translate(-50%, -50%) translateY(-${radius}px) rotate(180deg)`;

                spinner.appendChild(triangle);
                orbit.appendChild(spinner);
                fragment.appendChild(orbit);
            }

            cursorOrbitsEl.appendChild(fragment);
        }

        function spawnFloat(text, x, y, className) {
            if (!effectsLayerEl) return;
            const el = document.createElement('div');
            el.className = `float-text ${className || ''}`.trim();
            el.textContent = text;
            el.style.left = `${x}px`;
            el.style.top = `${y}px`;
            effectsLayerEl.appendChild(el);
            el.addEventListener('animationend', () => el.remove());
        }

        function unlockAchievement(state, achievement) {
            if (state.achievements.has(achievement.id)) return;
            state.achievements.add(achievement.id);
            spawnFloat('Achievement!', cookieEl.offsetWidth / 2, -4, 'bonus');
        }

        let lastAchievementKey = '';
        function achievementUnlocked(state, achievement) {
            const totalUpgrades = state.upgrades.reduce((sum, u) => sum + u.count, 0);
            switch (achievement.type) {
                case 'clicks':
                    return state.totalClicks >= achievement.value;
                case 'totalCookies':
                    return state.totalCookies >= achievement.value;
                case 'cps':
                    return totalCPS(state) >= achievement.value;
                case 'upgrades':
                    return totalUpgrades >= achievement.value;
                case 'goldenClicks':
                    return state.goldenClicks >= achievement.value;
                default:
                    return false;
            }
        }

        function updateAchievements(state) {
            ACHIEVEMENTS.forEach(achievement => {
                if (!state.achievements.has(achievement.id) && achievementUnlocked(state, achievement)) {
                    unlockAchievement(state, achievement);
                }
            });

            if (!achievementsEl) return;
            const key = Array.from(state.achievements).sort().join('|');
            if (key === lastAchievementKey && achievementsEl.children.length === ACHIEVEMENTS.length) {
                return;
            }
            lastAchievementKey = key;
            achievementsEl.innerHTML = '';
            ACHIEVEMENTS.forEach(achievement => {
                const item = document.createElement('div');
                item.className = `achievement ${state.achievements.has(achievement.id) ? '' : 'locked'}`.trim();

                const title = document.createElement('div');
                title.className = 'achievement-title';
                title.textContent = achievement.name;

                const desc = document.createElement('div');
                desc.className = 'muted';
                desc.textContent = achievement.description;

                item.appendChild(title);
                item.appendChild(desc);
                achievementsEl.appendChild(item);
            });
        }

        let lastMilestoneUpdate = 0;
        function updateMilestones(state) {
            if (!milestonesEl) return;
            const now = performance.now();
            if (now - lastMilestoneUpdate < 250 && milestonesEl.children.length > 0) return;
            lastMilestoneUpdate = now;
            milestonesEl.innerHTML = '';
            const values = {
                'total-cookies': state.totalCookies,
                'total-clicks': state.totalClicks,
                'cps': totalCPS(state)
            };

            MILESTONES.forEach(milestone => {
                const current = values[milestone.id] || 0;
                const next = milestone.thresholds.find(t => current < t) || milestone.thresholds[milestone.thresholds.length - 1];
                const prev = milestone.thresholds.findIndex(t => current < t) - 1;
                const prevValue = prev >= 0 ? milestone.thresholds[prev] : 0;
                const progress = next > prevValue ? Math.min(1, (current - prevValue) / (next - prevValue)) : 1;

                const item = document.createElement('div');
                item.className = 'milestone';
                item.innerHTML = `
                    <div>${milestone.label}: ${formatNumber(current)} / ${formatNumber(next)}</div>
                    <div class="milestone-bar"><div class="milestone-fill" style="width:${Math.round(progress * 100)}%"></div></div>
                `;
                milestonesEl.appendChild(item);
            });
        }

        function spawnGoldenCookie() {
            if (!goldenCookieEl || goldenCookieEl.style.display === 'block') return;
            const zone = cookieEl.getBoundingClientRect();
            const size = 44;
            const padding = 10;
            const maxX = Math.max(padding, zone.width - size - padding);
            const maxY = Math.max(padding, zone.height - size - padding);
            const x = padding + Math.random() * maxX;
            const y = padding + Math.random() * maxY;
            goldenCookieEl.style.left = `${x}px`;
            goldenCookieEl.style.top = `${y}px`;
            goldenCookieEl.style.display = 'block';

            setTimeout(() => {
                if (goldenCookieEl) goldenCookieEl.style.display = 'none';
            }, 6500);
        }

        // ====== Game Logic ======
        let state = load();
        buildShop(state);
        updateUI(state);

        function buyUpgrade(id) {
            const upg = state.upgrades.find(u => u.id === id);
            if (!upg) return;
            const cost = costFor(upg);
            if (state.cookies < cost) return;

            state.cookies -= cost;
            upg.count += 1;

            // Recompute CPC if this upgrade affects clicking
            if (upg.cpc > 0) {
                recomputeCPC(state);
            }

            const card = document.getElementById(`upgrade-${upg.id}`);
            if (card) {
                card.classList.remove('purchase-pulse');
                void card.offsetWidth;
                card.classList.add('purchase-pulse');
            }

            updateUI(state);
            save(state);
        }

        cookieEl.addEventListener('click', (event) => {
            state.cookies += state.cpc;
            state.totalCookies += state.cpc;
            state.totalClicks += 1;
            updateUI(state);
            // Small visual feedback
            cookieEl.style.transform = 'scale(0.96)';
            setTimeout(() => cookieEl.style.transform = '', 80);
            if (event && effectsLayerEl) {
                const rect = effectsLayerEl.getBoundingClientRect();
                const x = event.clientX - rect.left;
                const y = event.clientY - rect.top;
                spawnFloat(`+${formatNumber(state.cpc)}`, x, y);
            }
            if (Math.random() < 0.02) {
                spawnGoldenCookie();
            }
            // Save-on-action
            save(state);
        });

        if (goldenCookieEl) {
            goldenCookieEl.addEventListener('click', (event) => {
                const bonus = Math.max(25, Math.round(totalCPS(state) * 15), state.cpc * 20);
                state.cookies += bonus;
                state.totalCookies += bonus;
                state.goldenClicks += 1;
                goldenCookieEl.style.display = 'none';
                if (event && effectsLayerEl) {
                    const rect = effectsLayerEl.getBoundingClientRect();
                    const x = event.clientX - rect.left;
                    const y = event.clientY - rect.top;
                    spawnFloat(`+${formatNumber(bonus)}`, x, y, 'bonus');
                }
                updateUI(state);
                save(state);
            });
        }

        if (secretRickroll) {
            secretRickroll.addEventListener('click', () => {
                window.open('https://www.youtube.com/watch?v=dQw4w9WgXcQ', '_blank', 'noopener');
            });
        }

        resetButton.addEventListener('click', () => {
            const sure = confirm('Reset all progress? This cannot be undone.');
            if (!sure) return;
            localStorage.removeItem(SAVE_KEY);
            state = newState();
            buildShop(state);
            updateUI(state);
        });

        // Game loop: add CPS over time (smooth)
        let lastTick = performance.now();
        function tick() {
            const now = performance.now();
            const deltaSec = (now - lastTick) / 1000;
            lastTick = now;

            const cps = totalCPS(state);
            if (cps > 0 && deltaSec > 0) {
                const earned = cps * deltaSec;
                state.cookies += earned;
                state.totalCookies += earned;
                updateUI(state);
            }
            requestAnimationFrame(tick);
        }
        requestAnimationFrame(tick);

        // Autosave every 5 seconds
        setInterval(() => save(state), 5000);

        // Periodic chance for a golden cookie event
        setInterval(() => {
            if (Math.random() < 0.35) {
                spawnGoldenCookie();
            }
        }, 20000);
    </script>
</body>

</html>
